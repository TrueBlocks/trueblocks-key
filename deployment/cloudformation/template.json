{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "AWS SAM template with a simple API definition",
    "Parameters": {
        "QnBetaTestApiKeyName": {
            "Type": "String",
            "Default": "qn-beta-test"
        },
        "UsersQnTableName": {
            "Type": "String",
            "Default": "key-prod-users-qn"
        },
        "AppearancesQueueBatchSize": {
            "Type": "Number",
            "Default": "10"
        },
        "RDSMasterUserName": {
            "Type": "String",
            "Default": "key_admin"
        },
        "QnApiStageName": {
            "Type": "String",
            "Default": "prod"
        },
        "RDSDBName": {
            "Type": "String",
            "Default": "key_index"
        }
    },
    "Outputs": {
        "AppearancesQueueIngestUserAccessKey": {
            "Description": "Access key to ingest new queue items",
            "Value": {
                "Ref": "AppearancesQueueIngestUserKey"
            }
        },
        "AppearancesQueueIngestUserSecretKey": {
            "Description": "Secret key to ingest new queue items",
            "Value": {
                "Fn::GetAtt": [
                    "AppearancesQueueIngestUserKey",
                    "SecretAccessKey"
                ]
            }
        }
    },
    "Resources": {
        "QnApiCloudWatchRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": {
                        "Action": "sts:AssumeRole",
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "apigateway.amazonaws.com"
                        }
                    }
                },
                "Path": "/",
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs"
                ]
            },
            "Metadata": {
                "SamResourceId": "QnApiCloudWatchRole"
            }
        },
        "RpcFunctionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Action": [
                                "sts:AssumeRole"
                            ],
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            }
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole",
                    "arn:aws:iam::aws:policy/CloudWatchLambdaInsightsExecutionRolePolicy"
                ],
                "Policies": [
                    {
                        "PolicyName": "RpcFunctionRolePolicy1",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetResourcePolicy",
                                        "secretsmanager:GetSecretValue",
                                        "secretsmanager:DescribeSecret",
                                        "secretsmanager:ListSecretVersionIds"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "IndexDatabase",
                                            "MasterUserSecret.SecretArn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "lambda:createdBy",
                        "Value": "SAM"
                    }
                ]
            }
        },
        "StatsApi": {
            "Type": "AWS::ApiGateway::RestApi",
            "Metadata": {
                "SamResourceId": "StatsApi"
            },
            "Properties": {
                "Body": {
                    "info": {
                        "version": "1.0",
                        "title": {
                            "Ref": "AWS::StackName"
                        }
                    },
                    "paths": {
                        "/stats": {
                            "get": {
                                "x-amazon-apigateway-integration": {
                                    "httpMethod": "POST",
                                    "type": "aws_proxy",
                                    "uri": {
                                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${StatsFunction.Arn}/invocations"
                                    }
                                },
                                "security": [
                                    {
                                        "api_key": []
                                    }
                                ],
                                "responses": {}
                            }
                        }
                    },
                    "swagger": "2.0",
                    "securityDefinitions": {
                        "api_key": {
                            "type": "apiKey",
                            "name": "x-api-key",
                            "in": "header"
                        }
                    }
                }
            }
        },
        "StatsFunctionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Action": [
                                "sts:AssumeRole"
                            ],
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            }
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole",
                    "arn:aws:iam::aws:policy/CloudWatchLambdaInsightsExecutionRolePolicy",
                    "arn:aws:iam::aws:policy/AmazonDynamoDBReadOnlyAccess"
                ],
                "Policies": [
                    {
                        "PolicyName": "StatsFunctionRolePolicy2",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetResourcePolicy",
                                        "secretsmanager:GetSecretValue",
                                        "secretsmanager:DescribeSecret",
                                        "secretsmanager:ListSecretVersionIds"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "IndexDatabase",
                                            "MasterUserSecret.SecretArn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "lambda:createdBy",
                        "Value": "SAM"
                    }
                ]
            }
        },
        "AppearancesQueue": {
            "Type": "AWS::SQS::Queue",
            "Metadata": {
                "SamResourceId": "AppearancesQueue"
            }
        },
        "AppearancesQueueConsumeIngest": {
            "Type": "AWS::Lambda::EventSourceMapping",
            "Properties": {
                "BatchSize": {
                    "Ref": "AppearancesQueueBatchSize"
                },
                "EventSourceArn": {
                    "Fn::GetAtt": [
                        "AppearancesQueue",
                        "Arn"
                    ]
                },
                "FunctionName": {
                    "Ref": "AppearancesQueueConsume"
                }
            }
        },
        "AppearancesQueueIngestUser": {
            "Type": "AWS::IAM::User",
            "Properties": {
                "UserName": "appearances-queue-ingester",
                "Policies": [
                    {
                        "PolicyName": "appearances-queue-ingest-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sqs:SendMessage"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "AppearancesQueue",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ]
            },
            "Metadata": {
                "SamResourceId": "AppearancesQueueIngestUser"
            }
        },
        "AppearancesQueueConsumeRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Action": [
                                "sts:AssumeRole"
                            ],
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            }
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole",
                    "arn:aws:iam::aws:policy/CloudWatchLambdaInsightsExecutionRolePolicy",
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaSQSQueueExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "AppearancesQueueConsumeRolePolicy1",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetResourcePolicy",
                                        "secretsmanager:GetSecretValue",
                                        "secretsmanager:DescribeSecret",
                                        "secretsmanager:ListSecretVersionIds"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "IndexDatabase",
                                            "MasterUserSecret.SecretArn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "lambda:createdBy",
                        "Value": "SAM"
                    }
                ]
            }
        },
        "QnProvisionFunctionDeactivatePermissionStage": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "QnProvisionFunction"
                },
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": [
                        "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${__ApiId__}/${__Stage__}/DELETE/deactivate_endpoint",
                        {
                            "__ApiId__": {
                                "Ref": "QnApi"
                            },
                            "__Stage__": "*"
                        }
                    ]
                }
            }
        },
        "RDSLowStorageAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": "RDS Low Storage Alarm",
                "AlarmDescription": "This alarm is triggered when RDS storage is lower than or equal to 10GB",
                "AlarmActions": [
                    {
                        "Ref": "AlarmNotification"
                    }
                ],
                "MetricName": "FreeStorageSpace",
                "Namespace": "AWS/RDS",
                "Statistic": "Average",
                "Dimensions": [
                    {
                        "Name": "DBInstanceIdentifier",
                        "Value": {
                            "Fn::Sub": "${AWS::StackName}-index"
                        }
                    }
                ],
                "Period": 60,
                "EvaluationPeriods": 1,
                "DatapointsToAlarm": 1,
                "Threshold": 21474836480,
                "ComparisonOperator": "LessThanOrEqualToThreshold",
                "TreatMissingData": "missing"
            },
            "Metadata": {
                "SamResourceId": "RDSLowStorageAlarm"
            }
        },
        "StatsApiStage": {
            "Type": "AWS::ApiGateway::Stage",
            "Properties": {
                "DeploymentId": {
                    "Ref": "StatsApiDeployment59e230b779"
                },
                "RestApiId": {
                    "Ref": "StatsApi"
                },
                "StageName": {
                    "Ref": "QnApiStageName"
                }
            }
        },
        "QnHealthCheckFunction": {
            "Type": "AWS::Lambda::Function",
            "Metadata": {
                "SamResourceId": "QnHealthCheckFunction"
            },
            "Properties": {
                "Code": {
                    "S3Bucket": "aws-sam-cli-managed-default-samclisourcebucket-xfxhsc3bo3na",
                    "S3Key": "dfa9911f6529869e40a446f36548dedb"
                },
                "Handler": "healthcheck",
                "MemorySize": 128,
                "Role": {
                    "Fn::GetAtt": [
                        "QnHealthCheckFunctionRole",
                        "Arn"
                    ]
                },
                "Runtime": "go1.x",
                "Timeout": 30,
                "VpcConfig": {
                    "SecurityGroupIds": [
                        {
                            "Ref": "LambdaSecurityGroup"
                        }
                    ],
                    "SubnetIds": [
                        {
                            "Ref": "privateLambdaSubnet1"
                        },
                        {
                            "Ref": "privateLambdaSubnet2"
                        }
                    ]
                },
                "Environment": {
                    "Variables": {
                        "KY_DATABASE_DEFAULT_HOST": {
                            "Fn::GetAtt": [
                                "IndexDatabase",
                                "Endpoint.Address"
                            ]
                        },
                        "KY_DATABASE_DEFAULT_PORT": {
                            "Fn::GetAtt": [
                                "IndexDatabase",
                                "Endpoint.Port"
                            ]
                        },
                        "KY_DATABASE_DEFAULT_USER": {
                            "Ref": "RDSMasterUserName"
                        },
                        "KY_DATABASE_DEFAULT_AWSSECRET": {
                            "Fn::GetAtt": [
                                "IndexDatabase",
                                "MasterUserSecret.SecretArn"
                            ]
                        },
                        "KY_DATABASE_DEFAULT_DATABASE": {
                            "Ref": "RDSDBName"
                        }
                    }
                },
                "Tags": [
                    {
                        "Key": "lambda:createdBy",
                        "Value": "SAM"
                    }
                ],
                "Layers": [
                    {
                        "Fn::Sub": "arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:38"
                    }
                ],
                "Architectures": [
                    "x86_64"
                ]
            }
        },
        "DevOpsFs": {
            "Type": "AWS::EFS::FileSystem",
            "Properties": {
                "AvailabilityZoneName": "us-east-1a",
                "BackupPolicy": {
                    "Status": "DISABLED"
                },
                "Encrypted": false,
                "FileSystemPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "elasticfilesystem:*",
                                "datasync:*"
                            ],
                            "Principal": {
                                "AWS": "*"
                            }
                        }
                    ]
                }
            },
            "Metadata": {
                "SamResourceId": "DevOpsFs"
            }
        },
        "StatsFunctionApiEventPermissionStage": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "StatsFunction"
                },
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": [
                        "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${__ApiId__}/${__Stage__}/GET/stats",
                        {
                            "__ApiId__": {
                                "Ref": "StatsApi"
                            },
                            "__Stage__": "*"
                        }
                    ]
                }
            }
        },
        "StatsApiApiKey": {
            "Type": "AWS::ApiGateway::ApiKey",
            "DependsOn": [
                "StatsApiUsagePlan"
            ],
            "Properties": {
                "Enabled": true,
                "StageKeys": [
                    {
                        "RestApiId": {
                            "Ref": "StatsApi"
                        },
                        "StageName": {
                            "Ref": "StatsApiStage"
                        }
                    }
                ]
            }
        },
        "privateLambdaSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "RDSVPC"
                },
                "CidrBlock": "172.32.32.0/20",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                }
            },
            "Metadata": {
                "SamResourceId": "privateLambdaSubnet1"
            }
        },
        "UsagePlanQnBetaTest": {
            "Type": "AWS::ApiGateway::UsagePlan",
            "DependsOn": [
                "QnApiStage"
            ],
            "Properties": {
                "ApiStages": [
                    {
                        "ApiId": {
                            "Ref": "QnApi"
                        },
                        "Stage": {
                            "Ref": "QnApiStageName"
                        }
                    }
                ],
                "Description": "Test plan for QN beta testing",
                "UsagePlanName": "qn-beta-test"
            },
            "Metadata": {
                "SamResourceId": "UsagePlanQnBetaTest"
            }
        },
        "RoutePublicSubnet": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicDevOpsSubnet"
                }
            },
            "Metadata": {
                "SamResourceId": "RoutePublicSubnet"
            }
        },
        "AppearancesQueueStuckMessageAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": "Appearances Queue Message Stuck",
                "AlarmDescription": "Alarms if the SQS Queue has messages in it for too long",
                "AlarmActions": [
                    {
                        "Ref": "AlarmNotification"
                    }
                ],
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "QueueName",
                        "Value": {
                            "Fn::GetAtt": [
                                "AppearancesQueue",
                                "QueueName"
                            ]
                        }
                    }
                ],
                "EvaluationPeriods": 1,
                "MetricName": "ApproximateAgeOfOldestMessage",
                "Namespace": "AWS/SQS",
                "Period": 3600,
                "Statistic": "Maximum",
                "Threshold": 14400,
                "TreatMissingData": "notBreaching",
                "Unit": "Seconds"
            },
            "Metadata": {
                "SamResourceId": "AppearancesQueueStuckMessageAlarm"
            }
        },
        "DevOpsDbUploadBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": "key-devops-db-upload"
            },
            "Metadata": {
                "SamResourceId": "DevOpsDbUploadBucket"
            }
        },
        "QnAuthorizer": {
            "Type": "AWS::Lambda::Function",
            "DependsOn": [
                "QnProvisionSecret"
            ],
            "Metadata": {
                "SamResourceId": "QnAuthorizer"
            },
            "Properties": {
                "Code": {
                    "S3Bucket": "aws-sam-cli-managed-default-samclisourcebucket-xfxhsc3bo3na",
                    "S3Key": "7ce24e8093eee3abd0ef936e2b04f554"
                },
                "Handler": "authorizer",
                "MemorySize": 128,
                "Role": {
                    "Fn::GetAtt": [
                        "QnAuthorizerRole",
                        "Arn"
                    ]
                },
                "Runtime": "go1.x",
                "Timeout": 30,
                "Environment": {
                    "Variables": {
                        "KY_QNPROVISION_AWSSECRET": {
                            "Ref": "QnProvisionSecret"
                        },
                        "KY_QNPROVISION_TABLENAME": {
                            "Ref": "UsersQn"
                        }
                    }
                },
                "Tags": [
                    {
                        "Key": "lambda:createdBy",
                        "Value": "SAM"
                    }
                ],
                "Layers": [
                    {
                        "Fn::Sub": "arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:38"
                    }
                ],
                "Architectures": [
                    "x86_64"
                ]
            }
        },
        "StatsApiUsagePlan": {
            "Type": "AWS::ApiGateway::UsagePlan",
            "DependsOn": [
                "StatsApi"
            ],
            "Properties": {
                "ApiStages": [
                    {
                        "ApiId": {
                            "Ref": "StatsApi"
                        },
                        "Stage": {
                            "Ref": "StatsApiStage"
                        }
                    }
                ],
                "Quota": {
                    "Limit": 44640,
                    "Period": "MONTH"
                }
            }
        },
        "QnProvisionFunctionDeprovisionPermissionStage": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "QnProvisionFunction"
                },
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": [
                        "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${__ApiId__}/${__Stage__}/DELETE/deprovision",
                        {
                            "__ApiId__": {
                                "Ref": "QnApi"
                            },
                            "__Stage__": "*"
                        }
                    ]
                }
            }
        },
        "QnApiDeployment6bca1c444c": {
            "Type": "AWS::ApiGateway::Deployment",
            "Properties": {
                "Description": "RestApi deployment id: 6bca1c444cc4645ace89679b99f4f13165146259",
                "RestApiId": {
                    "Ref": "QnApi"
                },
                "StageName": "Stage"
            }
        },
        "AlarmNotification": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "Subscription": [
                    {
                        "Protocol": "email",
                        "Endpoint": "dawid@quickblocks.io"
                    }
                ]
            },
            "Metadata": {
                "SamResourceId": "AlarmNotification"
            }
        },
        "RpcFunctionApiEventPermissionStage": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "RpcFunction"
                },
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": [
                        "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${__ApiId__}/${__Stage__}/POST/rpc",
                        {
                            "__ApiId__": {
                                "Ref": "QnApi"
                            },
                            "__Stage__": "*"
                        }
                    ]
                }
            }
        },
        "QnApiLambdaAuthorizerAuthorizerPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Fn::GetAtt": [
                        "QnAuthorizer",
                        "Arn"
                    ]
                },
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": [
                        "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${__ApiId__}/authorizers/*",
                        {
                            "__ApiId__": {
                                "Ref": "QnApi"
                            }
                        }
                    ]
                }
            }
        },
        "DevOpsInstanceKeyPair": {
            "Type": "AWS::EC2::KeyPair",
            "Properties": {
                "KeyName": "devops-instance-keypair"
            },
            "Metadata": {
                "SamResourceId": "DevOpsInstanceKeyPair"
            }
        },
        "DynamoDbEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "DependsOn": [
                "LambdaSecurityGroup"
            ],
            "Properties": {
                "VpcEndpointType": "Gateway",
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.dynamodb"
                },
                "VpcId": {
                    "Ref": "RDSVPC"
                },
                "RouteTableIds": [
                    {
                        "Ref": "RDSVPCRouteTable"
                    }
                ]
            },
            "Metadata": {
                "SamResourceId": "DynamoDbEndpoint"
            }
        },
        "DevOpsInstance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "InstanceType": "t2.micro",
                "ImageId": "ami-0c7217cdde317cfec",
                "KeyName": {
                    "Ref": "DevOpsInstanceKeyPair"
                },
                "SecurityGroupIds": [
                    {
                        "Fn::GetAtt": [
                            "DevOpsInstanceSecurityGroup",
                            "GroupId"
                        ]
                    }
                ],
                "SubnetId": {
                    "Ref": "PublicDevOpsSubnet"
                }
            },
            "Metadata": {
                "SamResourceId": "DevOpsInstance"
            }
        },
        "AppearancesQueueNoMessagesAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": "Appearances Queue No Messages",
                "AlarmDescription": "Alarms if the SQS Queue is not receiving new messages",
                "AlarmActions": [
                    {
                        "Ref": "AlarmNotification"
                    }
                ],
                "ComparisonOperator": "LessThanOrEqualToThreshold",
                "Dimensions": [
                    {
                        "Name": "QueueName",
                        "Value": {
                            "Fn::GetAtt": [
                                "AppearancesQueue",
                                "QueueName"
                            ]
                        }
                    }
                ],
                "EvaluationPeriods": 1,
                "MetricName": "NumberOfMessagesSent",
                "Namespace": "AWS/SQS",
                "Period": 43200,
                "Statistic": "Sum",
                "Threshold": 0,
                "TreatMissingData": "notBreaching",
                "Unit": "Count"
            },
            "Metadata": {
                "SamResourceId": "AppearancesQueueNoMessagesAlarm"
            }
        },
        "RDSLowMemoryAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": "RDS Low Memory Alarm",
                "AlarmDescription": "This alarm is triggered when RDS memory is lower than or equal to 1GB",
                "AlarmActions": [
                    {
                        "Ref": "AlarmNotification"
                    }
                ],
                "MetricName": "FreeableMemory",
                "Namespace": "AWS/RDS",
                "Statistic": "Average",
                "Dimensions": [
                    {
                        "Name": "DBInstanceIdentifier",
                        "Value": {
                            "Fn::Sub": "${AWS::StackName}-index"
                        }
                    }
                ],
                "Period": 60,
                "EvaluationPeriods": 1,
                "DatapointsToAlarm": 1,
                "Threshold": 1073741824,
                "ComparisonOperator": "LessThanOrEqualToThreshold",
                "TreatMissingData": "missing"
            },
            "Metadata": {
                "SamResourceId": "RDSLowMemoryAlarm"
            }
        },
        "QnApiStage": {
            "Type": "AWS::ApiGateway::Stage",
            "Properties": {
                "AccessLogSetting": {
                    "DestinationArn": {
                        "Fn::GetAtt": [
                            "QnApiLogGroup",
                            "Arn"
                        ]
                    },
                    "Format": "$context.extendedRequestId $context.identity.sourceIp $context.identity.caller $context.identity.user [$context.requestTime] \"$context.httpMethod $context.resourcePath $context.protocol\" $context.status $context.responseLength $context.requestId"
                },
                "DeploymentId": {
                    "Ref": "QnApiDeployment6bca1c444c"
                },
                "RestApiId": {
                    "Ref": "QnApi"
                },
                "StageName": {
                    "Ref": "QnApiStageName"
                },
                "MethodSettings": [
                    {
                        "HttpMethod": "*",
                        "ResourcePath": "/*",
                        "LoggingLevel": "INFO"
                    }
                ]
            }
        },
        "UsersQn": {
            "Type": "AWS::DynamoDB::Table",
            "Metadata": {
                "SamResourceId": "UsersQn"
            },
            "Properties": {
                "AttributeDefinitions": [
                    {
                        "AttributeName": "QuicknodeId",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "QuicknodeId",
                        "KeyType": "HASH"
                    }
                ],
                "TableName": {
                    "Fn::Sub": "${AWS::StackName}-${UsersQnTableName}"
                },
                "BillingMode": "PAY_PER_REQUEST"
            }
        },
        "RDSImportFromS3Role": {
            "Type": "AWS::IAM::Role",
            "DependsOn": [
                "DevOpsDbUploadBucket"
            ],
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": {
                        "Action": "sts:AssumeRole",
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "rds.amazonaws.com"
                        }
                    }
                },
                "Policies": [
                    {
                        "PolicyName": "rdsImportFromS3",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Sid": "s3import",
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    "arn:aws:s3:::",
                                                    {
                                                        "Ref": "DevOpsDbUploadBucket"
                                                    }
                                                ]
                                            ]
                                        },
                                        {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    "arn:aws:s3:::",
                                                    {
                                                        "Ref": "DevOpsDbUploadBucket"
                                                    },
                                                    "/*"
                                                ]
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ]
            },
            "Metadata": {
                "SamResourceId": "RDSImportFromS3Role"
            }
        },
        "QnProvisionFunction": {
            "Type": "AWS::Lambda::Function",
            "Metadata": {
                "SamResourceId": "QnProvisionFunction"
            },
            "Properties": {
                "Code": {
                    "S3Bucket": "aws-sam-cli-managed-default-samclisourcebucket-xfxhsc3bo3na",
                    "S3Key": "0e0df3e99dffea1b6bd78e40ca19b8fc"
                },
                "Handler": "provision",
                "MemorySize": 128,
                "Role": {
                    "Fn::GetAtt": [
                        "QnProvisionFunctionRole",
                        "Arn"
                    ]
                },
                "Runtime": "go1.x",
                "Timeout": 30,
                "Environment": {
                    "Variables": {
                        "KY_QNPROVISION_AWSSECRET": {
                            "Ref": "QnProvisionSecret"
                        },
                        "KY_QNPROVISION_TABLENAME": {
                            "Ref": "UsersQn"
                        }
                    }
                },
                "Tags": [
                    {
                        "Key": "lambda:createdBy",
                        "Value": "SAM"
                    }
                ],
                "Layers": [
                    {
                        "Fn::Sub": "arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:38"
                    }
                ],
                "Architectures": [
                    "x86_64"
                ]
            }
        },
        "PrivateLambdaRouteTableSubnet2": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "RDSVPCRouteTable"
                },
                "SubnetId": {
                    "Ref": "privateLambdaSubnet2"
                }
            },
            "Metadata": {
                "SamResourceId": "PrivateLambdaRouteTableSubnet2"
            }
        },
        "LambdaSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "DependsOn": [
                "RDSVPC"
            ],
            "Properties": {
                "GroupDescription": "Security group for Lambda ENIs",
                "VpcId": {
                    "Ref": "RDSVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": -1,
                        "ToPort": 65535,
                        "FromPort": 0,
                        "CidrIp": {
                            "Fn::GetAtt": [
                                "privateLambdaSubnet1",
                                "CidrBlock"
                            ]
                        }
                    },
                    {
                        "IpProtocol": -1,
                        "ToPort": 65535,
                        "FromPort": 0,
                        "CidrIp": {
                            "Fn::GetAtt": [
                                "privateLambdaSubnet2",
                                "CidrBlock"
                            ]
                        }
                    }
                ]
            },
            "Metadata": {
                "SamResourceId": "LambdaSecurityGroup"
            }
        },
        "privateDBSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "RDSVPC"
                },
                "CidrBlock": "172.32.0.0/20",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                }
            },
            "Metadata": {
                "SamResourceId": "privateDBSubnet1"
            }
        },
        "privateDBSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "RDSVPC"
                },
                "CidrBlock": "172.32.16.0/20",
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                }
            },
            "Metadata": {
                "SamResourceId": "privateDBSubnet2"
            }
        },
        "QnGatewayResponseMissingAuthToken": {
            "Type": "AWS::ApiGateway::GatewayResponse",
            "Properties": {
                "ResponseParameters": {
                    "gatewayresponse.header.Access-Control-Allow-Origin": "'*'",
                    "gatewayresponse.header.Access-Control-Allow-Headers": "'*'"
                },
                "ResponseType": "MISSING_AUTHENTICATION_TOKEN",
                "RestApiId": {
                    "Ref": "QnApi"
                },
                "StatusCode": "401"
            },
            "Metadata": {
                "SamResourceId": "QnGatewayResponseMissingAuthToken"
            }
        },
        "privateLambdaSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "RDSVPC"
                },
                "CidrBlock": "172.32.48.0/20",
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                }
            },
            "Metadata": {
                "SamResourceId": "privateLambdaSubnet2"
            }
        },
        "IndexDatabaseEnhancedMonitoringRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole"
                ],
                "AssumeRolePolicyDocument": {
                    "Version": "2008-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "monitoring.rds.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                }
            },
            "Metadata": {
                "SamResourceId": "IndexDatabaseEnhancedMonitoringRole"
            }
        },
        "RpcFunction": {
            "Type": "AWS::Lambda::Function",
            "Metadata": {
                "SamResourceId": "RpcFunction"
            },
            "Properties": {
                "Code": {
                    "S3Bucket": "aws-sam-cli-managed-default-samclisourcebucket-xfxhsc3bo3na",
                    "S3Key": "c3b11311d42e2cb6d9ff211fa4225e17"
                },
                "Handler": "query",
                "MemorySize": 128,
                "Role": {
                    "Fn::GetAtt": [
                        "RpcFunctionRole",
                        "Arn"
                    ]
                },
                "Runtime": "go1.x",
                "Timeout": 30,
                "VpcConfig": {
                    "SecurityGroupIds": [
                        {
                            "Ref": "LambdaSecurityGroup"
                        }
                    ],
                    "SubnetIds": [
                        {
                            "Ref": "privateLambdaSubnet1"
                        },
                        {
                            "Ref": "privateLambdaSubnet2"
                        }
                    ]
                },
                "Environment": {
                    "Variables": {
                        "KY_QUERY_MAXLIMIT": 1000,
                        "KY_DATABASE_DEFAULT_HOST": {
                            "Fn::GetAtt": [
                                "IndexDatabase",
                                "Endpoint.Address"
                            ]
                        },
                        "KY_DATABASE_DEFAULT_PORT": {
                            "Fn::GetAtt": [
                                "IndexDatabase",
                                "Endpoint.Port"
                            ]
                        },
                        "KY_DATABASE_DEFAULT_USER": {
                            "Ref": "RDSMasterUserName"
                        },
                        "KY_DATABASE_DEFAULT_PASSWORD": "",
                        "KY_DATABASE_DEFAULT_AWSSECRET": {
                            "Fn::GetAtt": [
                                "IndexDatabase",
                                "MasterUserSecret.SecretArn"
                            ]
                        },
                        "KY_DATABASE_DEFAULT_DATABASE": {
                            "Ref": "RDSDBName"
                        }
                    }
                },
                "Tags": [
                    {
                        "Key": "lambda:createdBy",
                        "Value": "SAM"
                    }
                ],
                "Layers": [
                    {
                        "Fn::Sub": "arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:38"
                    }
                ],
                "Architectures": [
                    "x86_64"
                ]
            }
        },
        "QnProvisionFunctionProvisionPermissionStage": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "QnProvisionFunction"
                },
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": [
                        "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${__ApiId__}/${__Stage__}/POST/provision",
                        {
                            "__ApiId__": {
                                "Ref": "QnApi"
                            },
                            "__Stage__": "*"
                        }
                    ]
                }
            }
        },
        "QnHealthCheckFunctionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Action": [
                                "sts:AssumeRole"
                            ],
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            }
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole",
                    "arn:aws:iam::aws:policy/CloudWatchLambdaInsightsExecutionRolePolicy"
                ],
                "Policies": [
                    {
                        "PolicyName": "QnHealthCheckFunctionRolePolicy1",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetResourcePolicy",
                                        "secretsmanager:GetSecretValue",
                                        "secretsmanager:DescribeSecret",
                                        "secretsmanager:ListSecretVersionIds"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "IndexDatabase",
                                            "MasterUserSecret.SecretArn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "lambda:createdBy",
                        "Value": "SAM"
                    }
                ]
            }
        },
        "QnApiLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Join": [
                        "-",
                        [
                            {
                                "Ref": "QnApi"
                            },
                            "access-logs"
                        ]
                    ]
                }
            },
            "Metadata": {
                "SamResourceId": "QnApiLogGroup"
            }
        },
        "RDSSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupDescription": "description",
                "SubnetIds": [
                    {
                        "Ref": "privateDBSubnet1"
                    },
                    {
                        "Ref": "privateDBSubnet2"
                    }
                ]
            },
            "Metadata": {
                "SamResourceId": "RDSSubnetGroup"
            }
        },
        "RDSSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "DependsOn": [
                "LambdaSecurityGroup"
            ],
            "Properties": {
                "GroupDescription": "Allow Postgres access from lambda subnets",
                "VpcId": {
                    "Ref": "RDSVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 5432,
                        "ToPort": 5432,
                        "SourceSecurityGroupId": {
                            "Ref": "LambdaSecurityGroup"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 5432,
                        "ToPort": 5432,
                        "SourceSecurityGroupId": {
                            "Ref": "DevOpsInstanceSecurityGroup"
                        }
                    }
                ]
            },
            "Metadata": {
                "SamResourceId": "RDSSecurityGroup"
            }
        },
        "PublicDevOpsSubnet": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "RDSVPC"
                },
                "CidrBlock": "172.32.64.0/20",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true
            },
            "Metadata": {
                "SamResourceId": "PublicDevOpsSubnet"
            }
        },
        "RDSVPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "172.32.0.0/16",
                "EnableDnsSupport": true,
                "EnableDnsHostnames": true
            },
            "Metadata": {
                "SamResourceId": "RDSVPC"
            }
        },
        "QnProvisionFunctionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Action": [
                                "sts:AssumeRole"
                            ],
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            }
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                    "arn:aws:iam::aws:policy/CloudWatchLambdaInsightsExecutionRolePolicy",
                    "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess"
                ],
                "Policies": [
                    {
                        "PolicyName": "QnProvisionFunctionRolePolicy2",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetResourcePolicy",
                                        "secretsmanager:GetSecretValue",
                                        "secretsmanager:DescribeSecret",
                                        "secretsmanager:ListSecretVersionIds"
                                    ],
                                    "Resource": {
                                        "Ref": "QnProvisionSecret"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "QnProvisionFunctionRolePolicy3",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "apigateway:GET"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "lambda:createdBy",
                        "Value": "SAM"
                    }
                ]
            }
        },
        "PrivateDbRouteTableSubnet1": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "RDSVPCRouteTable"
                },
                "SubnetId": {
                    "Ref": "privateDBSubnet1"
                }
            },
            "Metadata": {
                "SamResourceId": "PrivateDbRouteTableSubnet1"
            }
        },
        "PrivateDbRouteTableSubnet2": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "RDSVPCRouteTable"
                },
                "SubnetId": {
                    "Ref": "privateDBSubnet2"
                }
            },
            "Metadata": {
                "SamResourceId": "PrivateDbRouteTableSubnet2"
            }
        },
        "StatsFunction": {
            "Type": "AWS::Lambda::Function",
            "Metadata": {
                "SamResourceId": "StatsFunction"
            },
            "Properties": {
                "Code": {
                    "S3Bucket": "aws-sam-cli-managed-default-samclisourcebucket-xfxhsc3bo3na",
                    "S3Key": "be5c8560901097dd64c5171b6c46a599"
                },
                "Handler": "stats",
                "MemorySize": 128,
                "Role": {
                    "Fn::GetAtt": [
                        "StatsFunctionRole",
                        "Arn"
                    ]
                },
                "Runtime": "go1.x",
                "Timeout": 30,
                "VpcConfig": {
                    "SecurityGroupIds": [
                        {
                            "Ref": "LambdaSecurityGroup"
                        }
                    ],
                    "SubnetIds": [
                        {
                            "Ref": "privateLambdaSubnet1"
                        },
                        {
                            "Ref": "privateLambdaSubnet2"
                        }
                    ]
                },
                "Environment": {
                    "Variables": {
                        "KY_QNPROVISION_TABLENAME": {
                            "Ref": "UsersQn"
                        },
                        "KY_DATABASE_DEFAULT_HOST": {
                            "Fn::GetAtt": [
                                "IndexDatabase",
                                "Endpoint.Address"
                            ]
                        },
                        "KY_DATABASE_DEFAULT_PORT": {
                            "Fn::GetAtt": [
                                "IndexDatabase",
                                "Endpoint.Port"
                            ]
                        },
                        "KY_DATABASE_DEFAULT_USER": {
                            "Ref": "RDSMasterUserName"
                        },
                        "KY_DATABASE_DEFAULT_PASSWORD": "",
                        "KY_DATABASE_DEFAULT_AWSSECRET": {
                            "Fn::GetAtt": [
                                "IndexDatabase",
                                "MasterUserSecret.SecretArn"
                            ]
                        },
                        "KY_DATABASE_DEFAULT_DATABASE": {
                            "Ref": "RDSDBName"
                        }
                    }
                },
                "Tags": [
                    {
                        "Key": "lambda:createdBy",
                        "Value": "SAM"
                    }
                ],
                "Layers": [
                    {
                        "Fn::Sub": "arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:38"
                    }
                ],
                "Architectures": [
                    "x86_64"
                ]
            }
        },
        "DevOpsInstanceSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": "DevOps SSH PSQL",
                "GroupDescription": "Allows SSH and PostgreSQL connections to DevOps instance",
                "VpcId": {
                    "Ref": "RDSVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 5432,
                        "ToPort": 5432,
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 2049,
                        "ToPort": 2049,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "ToPort": 65535,
                        "FromPort": 0,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            },
            "Metadata": {
                "SamResourceId": "DevOpsInstanceSecurityGroup"
            }
        },
        "StatsApiUsagePlanKey": {
            "Type": "AWS::ApiGateway::UsagePlanKey",
            "DependsOn": [
                "StatsApiApiKey"
            ],
            "Properties": {
                "KeyId": {
                    "Ref": "StatsApiApiKey"
                },
                "KeyType": "API_KEY",
                "UsagePlanId": {
                    "Ref": "StatsApiUsagePlan"
                }
            }
        },
        "LinkUsagePlanApiKeyQnBetaTest": {
            "Type": "AWS::ApiGateway::UsagePlanKey",
            "Properties": {
                "KeyId": {
                    "Ref": "ApiKeyQnBetaTest"
                },
                "KeyType": "API_KEY",
                "UsagePlanId": {
                    "Ref": "UsagePlanQnBetaTest"
                }
            },
            "Metadata": {
                "SamResourceId": "LinkUsagePlanApiKeyQnBetaTest"
            }
        },
        "QnApiLoggingRoleArn": {
            "Type": "AWS::ApiGateway::Account",
            "Properties": {
                "CloudWatchRoleArn": {
                    "Fn::GetAtt": [
                        "QnApiCloudWatchRole",
                        "Arn"
                    ]
                }
            },
            "Metadata": {
                "SamResourceId": "QnApiLoggingRoleArn"
            }
        },
        "QnHealthCheckFunctionApiEventPermissionStage": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "QnHealthCheckFunction"
                },
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": [
                        "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${__ApiId__}/${__Stage__}/GET/healthcheck",
                        {
                            "__ApiId__": {
                                "Ref": "QnApi"
                            },
                            "__Stage__": "*"
                        }
                    ]
                }
            }
        },
        "PublicRouteTable": {
            "DependsOn": [
                "InternetGatewayAttachment"
            ],
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "RDSVPC"
                }
            },
            "Metadata": {
                "SamResourceId": "PublicRouteTable"
            }
        },
        "AppearancesQueueConsume": {
            "Type": "AWS::Lambda::Function",
            "DependsOn": [
                "IndexDatabase",
                "AppearancesQueue"
            ],
            "Metadata": {
                "SamResourceId": "AppearancesQueueConsume"
            },
            "Properties": {
                "Code": {
                    "S3Bucket": "aws-sam-cli-managed-default-samclisourcebucket-xfxhsc3bo3na",
                    "S3Key": "2b7986a8dd836a02d840d39d1bf4b297"
                },
                "Handler": "consume",
                "MemorySize": 128,
                "Role": {
                    "Fn::GetAtt": [
                        "AppearancesQueueConsumeRole",
                        "Arn"
                    ]
                },
                "Runtime": "go1.x",
                "Timeout": 30,
                "VpcConfig": {
                    "SecurityGroupIds": [
                        {
                            "Ref": "LambdaSecurityGroup"
                        }
                    ],
                    "SubnetIds": [
                        {
                            "Ref": "privateLambdaSubnet1"
                        },
                        {
                            "Ref": "privateLambdaSubnet2"
                        }
                    ]
                },
                "Environment": {
                    "Variables": {
                        "KY_SQS_BATCHSIZE": {
                            "Ref": "AppearancesQueueBatchSize"
                        },
                        "KY_DATABASE_DEFAULT_HOST": {
                            "Fn::GetAtt": [
                                "IndexDatabase",
                                "Endpoint.Address"
                            ]
                        },
                        "KY_DATABASE_DEFAULT_PORT": {
                            "Fn::GetAtt": [
                                "IndexDatabase",
                                "Endpoint.Port"
                            ]
                        },
                        "KY_DATABASE_DEFAULT_USER": {
                            "Ref": "RDSMasterUserName"
                        },
                        "KY_DATABASE_DEFAULT_PASSWORD": "",
                        "KY_DATABASE_DEFAULT_AWSSECRET": {
                            "Fn::GetAtt": [
                                "IndexDatabase",
                                "MasterUserSecret.SecretArn"
                            ]
                        },
                        "KY_DATABASE_DEFAULT_DATABASE": {
                            "Ref": "RDSDBName"
                        }
                    }
                },
                "Tags": [
                    {
                        "Key": "lambda:createdBy",
                        "Value": "SAM"
                    }
                ],
                "Layers": [
                    {
                        "Fn::Sub": "arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:38"
                    }
                ],
                "Architectures": [
                    "x86_64"
                ]
            }
        },
        "IndexDatabaseParameterGroup": {
            "Type": "AWS::RDS::DBParameterGroup",
            "Properties": {
                "Description": "Index database parameters",
                "Family": "postgres15",
                "Parameters": {
                    "work_mem": 16384
                }
            },
            "Metadata": {
                "SamResourceId": "IndexDatabaseParameterGroup"
            }
        },
        "IndexDatabase": {
            "Type": "AWS::RDS::DBInstance",
            "DependsOn": [
                "RDSImportFromS3Role",
                "RDSSecurityGroup",
                "RDSSubnetGroup"
            ],
            "Properties": {
                "BackupRetentionPeriod": 4,
                "AutoMinorVersionUpgrade": true,
                "DBInstanceIdentifier": {
                    "Fn::Sub": "${AWS::StackName}-index"
                },
                "DBInstanceClass": "db.t4g.xlarge",
                "DBParameterGroupName": {
                    "Ref": "IndexDatabaseParameterGroup"
                },
                "Engine": "postgres",
                "AllocatedStorage": "1500",
                "StorageType": "gp3",
                "DBName": {
                    "Ref": "RDSDBName"
                },
                "MasterUsername": {
                    "Ref": "RDSMasterUserName"
                },
                "ManageMasterUserPassword": true,
                "DBSubnetGroupName": {
                    "Ref": "RDSSubnetGroup"
                },
                "VPCSecurityGroups": [
                    {
                        "Ref": "RDSSecurityGroup"
                    }
                ],
                "MonitoringInterval": 10,
                "MonitoringRoleArn": {
                    "Fn::GetAtt": [
                        "IndexDatabaseEnhancedMonitoringRole",
                        "Arn"
                    ]
                },
                "AssociatedRoles": [
                    {
                        "FeatureName": "s3Import",
                        "RoleArn": {
                            "Fn::GetAtt": [
                                "RDSImportFromS3Role",
                                "Arn"
                            ]
                        }
                    }
                ]
            },
            "Metadata": {
                "SamResourceId": "IndexDatabase"
            }
        },
        "StatsApiDeployment59e230b779": {
            "Type": "AWS::ApiGateway::Deployment",
            "Properties": {
                "Description": "RestApi deployment id: 59e230b779d3a002a98a087fae2e815f2f352e9c",
                "RestApiId": {
                    "Ref": "StatsApi"
                },
                "StageName": "Stage"
            }
        },
        "QnAuthorizerRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Action": [
                                "sts:AssumeRole"
                            ],
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            }
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                    "arn:aws:iam::aws:policy/CloudWatchLambdaInsightsExecutionRolePolicy",
                    "arn:aws:iam::aws:policy/AmazonDynamoDBReadOnlyAccess"
                ],
                "Policies": [
                    {
                        "PolicyName": "QnAuthorizerRolePolicy2",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetResourcePolicy",
                                        "secretsmanager:GetSecretValue",
                                        "secretsmanager:DescribeSecret",
                                        "secretsmanager:ListSecretVersionIds"
                                    ],
                                    "Resource": {
                                        "Ref": "QnProvisionSecret"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "lambda:createdBy",
                        "Value": "SAM"
                    }
                ]
            }
        },
        "QnProvisionSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Description": "QN Provision username and password",
                "SecretString": "{\"username\":\"Placeholder\",\"password\":\"placeholder\"}"
            },
            "Metadata": {
                "SamResourceId": "QnProvisionSecret"
            }
        },
        "RouteIG": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            },
            "Metadata": {
                "SamResourceId": "RouteIG"
            }
        },
        "DevOpsFsTarget": {
            "Type": "AWS::EFS::MountTarget",
            "Properties": {
                "FileSystemId": {
                    "Ref": "DevOpsFs"
                },
                "SubnetId": {
                    "Ref": "PublicDevOpsSubnet"
                },
                "SecurityGroups": [
                    {
                        "Ref": "DevOpsFsSecurityGroup"
                    }
                ]
            },
            "Metadata": {
                "SamResourceId": "DevOpsFsTarget"
            }
        },
        "PrivateLambdaRouteTableSubnet1": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "RDSVPCRouteTable"
                },
                "SubnetId": {
                    "Ref": "privateLambdaSubnet1"
                }
            },
            "Metadata": {
                "SamResourceId": "PrivateLambdaRouteTableSubnet1"
            }
        },
        "DevOpsFsSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "FileSystem Security Group",
                "VpcId": {
                    "Ref": "RDSVPC"
                },
                "GroupName": "devops-fs",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 2049,
                        "ToPort": 2049,
                        "SourceSecurityGroupId": {
                            "Ref": "DevOpsInstanceSecurityGroup"
                        }
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "ToPort": 65535,
                        "FromPort": 0,
                        "DestinationSecurityGroupId": {
                            "Ref": "DevOpsInstanceSecurityGroup"
                        }
                    }
                ]
            },
            "Metadata": {
                "SamResourceId": "DevOpsFsSecurityGroup"
            }
        },
        "SecretsManagerEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "DependsOn": [
                "LambdaSecurityGroup"
            ],
            "Properties": {
                "VpcEndpointType": "Interface",
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.secretsmanager"
                },
                "PrivateDnsEnabled": true,
                "VpcId": {
                    "Ref": "RDSVPC"
                },
                "SubnetIds": [
                    {
                        "Ref": "privateLambdaSubnet1"
                    },
                    {
                        "Ref": "privateLambdaSubnet2"
                    }
                ],
                "SecurityGroupIds": [
                    {
                        "Ref": "LambdaSecurityGroup"
                    }
                ]
            },
            "Metadata": {
                "SamResourceId": "SecretsManagerEndpoint"
            }
        },
        "ApiKeyQnBetaTest": {
            "Type": "AWS::ApiGateway::ApiKey",
            "DependsOn": [
                "UsagePlanQnBetaTest"
            ],
            "Properties": {
                "Name": {
                    "Ref": "QnBetaTestApiKeyName"
                },
                "Enabled": true
            },
            "Metadata": {
                "SamResourceId": "ApiKeyQnBetaTest"
            }
        },
        "RDSHighCPUAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": "RDS High CPU Alarm",
                "AlarmDescription": "This alarm is triggered when RDS CPU usage is greater than or equal to 70%",
                "AlarmActions": [
                    {
                        "Ref": "AlarmNotification"
                    }
                ],
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/RDS",
                "Statistic": "Average",
                "Dimensions": [
                    {
                        "Name": "DBInstanceIdentifier",
                        "Value": {
                            "Fn::Sub": "${AWS::StackName}-index"
                        }
                    }
                ],
                "Period": 60,
                "EvaluationPeriods": 1,
                "DatapointsToAlarm": 1,
                "Threshold": 70,
                "ComparisonOperator": "GreaterThanOrEqualToThreshold",
                "TreatMissingData": "missing"
            },
            "Metadata": {
                "SamResourceId": "RDSHighCPUAlarm"
            }
        },
        "InternetGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "RDSVPC"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            },
            "Metadata": {
                "SamResourceId": "InternetGatewayAttachment"
            }
        },
        "DevOpsFsAccessPoint": {
            "Type": "AWS::EFS::AccessPoint",
            "Properties": {
                "FileSystemId": {
                    "Ref": "DevOpsFs"
                },
                "PosixUser": {
                    "Uid": "13234",
                    "Gid": "1322",
                    "SecondaryGids": [
                        "1344",
                        "1452"
                    ]
                },
                "RootDirectory": {
                    "CreationInfo": {
                        "OwnerGid": "708798",
                        "OwnerUid": "7987987",
                        "Permissions": "0755"
                    },
                    "Path": "/efs"
                }
            },
            "Metadata": {
                "SamResourceId": "DevOpsFsAccessPoint"
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Metadata": {
                "SamResourceId": "InternetGateway"
            }
        },
        "QnApi": {
            "Type": "AWS::ApiGateway::RestApi",
            "DependsOn": [
                "QnAuthorizer"
            ],
            "Metadata": {
                "SamResourceId": "QnApi"
            },
            "Properties": {
                "Body": {
                    "info": {
                        "version": "1.0",
                        "title": {
                            "Ref": "AWS::StackName"
                        }
                    },
                    "paths": {
                        "/rpc": {
                            "post": {
                                "x-amazon-apigateway-integration": {
                                    "httpMethod": "POST",
                                    "type": "aws_proxy",
                                    "uri": {
                                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${RpcFunction.Arn}/invocations"
                                    }
                                },
                                "x-amazon-apigateway-request-validator": "body-only",
                                "security": [
                                    {
                                        "api_key": []
                                    },
                                    {
                                        "LambdaAuthorizer": []
                                    }
                                ],
                                "parameters": [
                                    {
                                        "required": true,
                                        "in": "body",
                                        "name": "rpcrequest",
                                        "schema": {
                                            "$ref": "#/definitions/rpcrequest"
                                        }
                                    }
                                ],
                                "responses": {}
                            }
                        },
                        "/deprovision": {
                            "delete": {
                                "x-amazon-apigateway-integration": {
                                    "httpMethod": "POST",
                                    "type": "aws_proxy",
                                    "uri": {
                                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${QnProvisionFunction.Arn}/invocations"
                                    }
                                },
                                "security": [
                                    {
                                        "NONE": []
                                    }
                                ],
                                "responses": {}
                            }
                        },
                        "/provision": {
                            "post": {
                                "x-amazon-apigateway-integration": {
                                    "httpMethod": "POST",
                                    "type": "aws_proxy",
                                    "uri": {
                                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${QnProvisionFunction.Arn}/invocations"
                                    }
                                },
                                "security": [
                                    {
                                        "NONE": []
                                    }
                                ],
                                "responses": {}
                            }
                        },
                        "/update": {
                            "put": {
                                "x-amazon-apigateway-integration": {
                                    "httpMethod": "POST",
                                    "type": "aws_proxy",
                                    "uri": {
                                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${QnProvisionFunction.Arn}/invocations"
                                    }
                                },
                                "security": [
                                    {
                                        "NONE": []
                                    }
                                ],
                                "responses": {}
                            }
                        },
                        "/deactivate_endpoint": {
                            "delete": {
                                "x-amazon-apigateway-integration": {
                                    "httpMethod": "POST",
                                    "type": "aws_proxy",
                                    "uri": {
                                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${QnProvisionFunction.Arn}/invocations"
                                    }
                                },
                                "security": [
                                    {
                                        "NONE": []
                                    }
                                ],
                                "responses": {}
                            }
                        },
                        "/healthcheck": {
                            "get": {
                                "x-amazon-apigateway-integration": {
                                    "httpMethod": "POST",
                                    "type": "aws_proxy",
                                    "uri": {
                                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${QnHealthCheckFunction.Arn}/invocations"
                                    }
                                },
                                "security": [
                                    {
                                        "NONE": []
                                    }
                                ],
                                "responses": {}
                            }
                        }
                    },
                    "securityDefinitions": {
                        "api_key": {
                            "type": "apiKey",
                            "name": "x-api-key",
                            "in": "header"
                        },
                        "LambdaAuthorizer": {
                            "in": "header",
                            "type": "apiKey",
                            "name": "Unused",
                            "x-amazon-apigateway-authorizer": {
                                "type": "request",
                                "identitySource": "method.request.header.x-quicknode-id, method.request.header.x-instance-id, method.request.header.x-qn-chain, method.request.header.x-qn-network",
                                "authorizerUri": {
                                    "Fn::Sub": [
                                        "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${__FunctionArn__}/invocations",
                                        {
                                            "__FunctionArn__": {
                                                "Fn::GetAtt": [
                                                    "QnAuthorizer",
                                                    "Arn"
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },
                            "x-amazon-apigateway-authtype": "custom"
                        }
                    },
                    "definitions": {
                        "rpcrequest": {
                            "required": [
                                "method",
                                "params"
                            ],
                            "type": "object",
                            "Properties": {
                                "params": {
                                    "items": {
                                        "perPage": {
                                            "type": "number"
                                        },
                                        "page": {
                                            "type": "number"
                                        },
                                        "address": {
                                            "required": true,
                                            "type": "string"
                                        }
                                    },
                                    "type": "array"
                                },
                                "jsonrpc": {
                                    "type": "string"
                                },
                                "id": {
                                    "type": "number"
                                },
                                "method": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "swagger": "2.0",
                    "x-amazon-apigateway-request-validators": {
                        "body-only": {
                            "validateRequestParameters": false,
                            "validateRequestBody": true
                        }
                    }
                },
                "ApiKeySourceType": "AUTHORIZER"
            }
        },
        "RDSVPCRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "RDSVPC"
                }
            },
            "Metadata": {
                "SamResourceId": "RDSVPCRouteTable"
            }
        },
        "QnProvisionFunctionUpdatePermissionStage": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "QnProvisionFunction"
                },
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": [
                        "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${__ApiId__}/${__Stage__}/PUT/update",
                        {
                            "__ApiId__": {
                                "Ref": "QnApi"
                            },
                            "__Stage__": "*"
                        }
                    ]
                }
            }
        },
        "AppearancesQueueIngestUserKey": {
            "Type": "AWS::IAM::AccessKey",
            "Properties": {
                "Status": "Active",
                "UserName": {
                    "Ref": "AppearancesQueueIngestUser"
                }
            },
            "Metadata": {
                "SamResourceId": "AppearancesQueueIngestUserKey"
            }
        }
    }
}
