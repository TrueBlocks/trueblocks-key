AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: AWS SAM template with a simple API definition

Parameters:
  RDSMasterUserName:
    Type: String
    Default: key_admin
  RDSDBName:
    Type: String
    Default: key_index
  UsersQnTableName:
    Type: String
    Default: key-prod-users-qn
  AppearancesQueueBatchSize:
    Type: Number
    Default: "10"
  QnApiStageName:
    Type: String
    Default: prod
  QnBetaTestApiKeyName:
    Type: String
    Default: qn-beta-test

# Global values that are applied to all applicable resources in this template
Globals:
  Function:
    Architectures: ["x86_64"]
    Timeout: 30
    Layers:
      - !Sub "arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:38"

Resources:
  ###
  # Databases
  ###

  ## SQL Appearances Database
  IndexDatabase:
    Type: AWS::RDS::DBInstance
    DependsOn:
      - RDSImportFromS3Role
      - RDSSecurityGroup
      - RDSSubnetGroup
    Properties:
      # Setting BackupRetentionPeriod to 0 DISABLES BACKUPS
      BackupRetentionPeriod: 4
      DBInstanceIdentifier: !Sub ${AWS::StackName}-index
      DBInstanceClass: db.t4g.medium # db.t3.micro
      DBParameterGroupName: !Ref IndexDatabaseParameterGroup
      Engine: postgres
      AllocatedStorage: "400"
      StorageType: "gp3"
      DBName: !Ref RDSDBName
      MasterUsername: !Ref RDSMasterUserName
      ManageMasterUserPassword: true
      DBSubnetGroupName: !Ref RDSSubnetGroup
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      MonitoringInterval: 10
      MonitoringRoleArn: !GetAtt IndexDatabaseEnhancedMonitoringRole.Arn
      AssociatedRoles:
      - FeatureName: s3Import
        RoleArn: !GetAtt RDSImportFromS3Role.Arn

  IndexDatabaseParameterGroup:
    Type: 'AWS::RDS::DBParameterGroup'
    Properties:
      Description: Index database parameters
      Family: postgres15
      Parameters:
        work_mem: 16384 # 16 MB
        # Below settings are useful when uploading large dataset
        # maintenance_work_mem: 'GREATEST({DBInstanceClassMemory/63963136*1024},65536)'
        # maintenance_work_mem: 3145728 # 3 GB in kB
        # autovacuum: false
        # max_wal_size: 10240
        # checkpoint_timeout: 600 # 10 min
        # synchronous_commit: 'off'


  # Index database enhanced monitoring role
  IndexDatabaseEnhancedMonitoringRole:
    Type: 'AWS::IAM::Role'
    Properties:
      ManagedPolicyArns:
      - 'arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole'
      AssumeRolePolicyDocument:
        Version: '2008-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: 'monitoring.rds.amazonaws.com'
          Action: 'sts:AssumeRole'

  # Allow importing db from S3
  RDSImportFromS3Role:
    Type: AWS::IAM::Role
    DependsOn:
      - DevOpsDbUploadBucket
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          Action: 'sts:AssumeRole'
          Effect: Allow
          Principal:
            Service: rds.amazonaws.com
      Policies:
        - PolicyName: rdsImportFromS3
          PolicyDocument:
            Version: '2012-10-17' # Policy Document
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource: !GetAtt DevOpsDbUploadBucket.Arn

  ### DynamoDB QN users
  UsersQn:
    Type: AWS::Serverless::SimpleTable
    Properties:
      PrimaryKey:
        Name: QuicknodeId
        Type: String
      TableName: !Sub ${AWS::StackName}-${UsersQnTableName}

  ###
  # Appearances Queue
  ###

  AppearancesQueueConsume:
    Type: AWS::Serverless::Function
    DependsOn:
      - IndexDatabase
      - AppearancesQueue
    Properties:
      MemorySize: 128
      Runtime: go1.x
      Handler: consume
      CodeUri: ../../queue/consume/lambda
      Events:
        Ingest:
          Type: SQS
          Properties:
            Queue: !GetAtt AppearancesQueue.Arn
            BatchSize: !Ref AppearancesQueueBatchSize
      VpcConfig: # For accessing RDS instance
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref privateLambdaSubnet1
          - !Ref privateLambdaSubnet2
      Environment:
        Variables:
          KY_SQS_BATCHSIZE: !Ref AppearancesQueueBatchSize
          KY_DATABASE_DEFAULT_HOST: !GetAtt IndexDatabase.Endpoint.Address
          KY_DATABASE_DEFAULT_PORT: !GetAtt IndexDatabase.Endpoint.Port
          KY_DATABASE_DEFAULT_USER: !Ref RDSMasterUserName
          KY_DATABASE_DEFAULT_PASSWORD: "" # Used only in integration tests
          KY_DATABASE_DEFAULT_AWSSECRET: !GetAtt IndexDatabase.MasterUserSecret.SecretArn
          KY_DATABASE_DEFAULT_DATABASE: !Ref RDSDBName
      Policies:
        - CloudWatchLambdaInsightsExecutionRolePolicy
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetResourcePolicy
                - secretsmanager:GetSecretValue
                - secretsmanager:DescribeSecret
                - secretsmanager:ListSecretVersionIds
              Resource: !GetAtt IndexDatabase.MasterUserSecret.SecretArn

  AppearancesQueue:
    Type: AWS::SQS::Queue

  ###
  # API
  ###

  QnApiLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Join
        - '-'
        - - !Ref QnApi
          - access-logs

  QnApi:
    Type: AWS::Serverless::Api
    DependsOn:
      - QnAuthorizer
    Properties:
      StageName: !Ref QnApiStageName
      ApiKeySourceType: AUTHORIZER
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          LoggingLevel: INFO
      AccessLogSetting:
        DestinationArn: !GetAtt QnApiLogGroup.Arn
        Format: $context.extendedRequestId $context.identity.sourceIp $context.identity.caller $context.identity.user [$context.requestTime] "$context.httpMethod $context.resourcePath $context.protocol" $context.status $context.responseLength $context.requestId
      Models:
        RpcRequest:
          type: object
          required:
            - method
            - params
          Properties:
            jsonrpc:
              type: string
            id:
              type: number
            method:
              type: string
            params:
              type: array
              items:
                address:
                  type: string
                  required: true
                page:
                  type: number
                perPage:
                  type: number
      Auth:
        # Authorizer
        DefaultAuthorizer: LambdaAuthorizer
        Authorizers:
          LambdaAuthorizer:
            # This setup uses default auth caching of 300 sec = 5 h
            FunctionPayloadType: REQUEST
            FunctionArn: !GetAtt QnAuthorizer.Arn
            Identity:
              Headers:
                - Authorization
                - x-quicknode-id
                - x-instance-id
                - x-qn-chain
                - x-qn-network

  # CloudWatch logging policies

  # Specifies the IAM role that API Gateway uses to write API logs to Amazon CloudWatch Logs
  QnApiLoggingRoleArn:
    Type: AWS::ApiGateway::Account
    Properties:
      CloudWatchRoleArn: !GetAtt QnApiCloudWatchRole.Arn

  # IAM Role with 'AmazonAPIGatewayPushToCloudWatchLogs' managed policy
  QnApiCloudWatchRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
        Path: /
        ManagedPolicyArns:
          - 'arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs'

  # For QuickNode, we need to override the default MISSING_AUTHENTICATION_TOKEN
  # status code. QN expects it to be 401, not 403
  QnGatewayResponseMissingAuthToken:
    Type: 'AWS::ApiGateway::GatewayResponse'
    Properties:
      ResponseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
        gatewayresponse.header.Access-Control-Allow-Headers: "'*'"
      ResponseType: MISSING_AUTHENTICATION_TOKEN
      RestApiId: !Ref QnApi
      StatusCode: "401"

  # ### QN Authorizer
  QnAuthorizer:
    Type: AWS::Serverless::Function
    DependsOn:
      - QnProvisionSecret
    Properties:
      MemorySize: 128
      Runtime: go1.x
      Handler: authorizer
      CodeUri: ../../quicknode/authorizer/lambda
      Environment:
        Variables:
          KY_QNPROVISION_AWSSECRET: !Ref QnProvisionSecret
          KY_QNPROVISION_TABLENAME: !Ref UsersQn
      Policies:
        - CloudWatchLambdaInsightsExecutionRolePolicy
        - AmazonDynamoDBReadOnlyAccess
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetResourcePolicy
                - secretsmanager:GetSecretValue
                - secretsmanager:DescribeSecret
                - secretsmanager:ListSecretVersionIds
              Resource: !Ref QnProvisionSecret

  # ### QN healthcheck

  QnHealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      MemorySize: 128
      Runtime: go1.x
      Handler: healthcheck
      CodeUri: ../../quicknode/healthcheck/lambda
      Events:
        ApiEvent:
          Type: Api
          Properties:
            # Make sure this endpoint does not require auth
            Auth:
              Authorizer: NONE
            Path: /healthcheck
            Method: get
            RestApiId:
              Ref: QnApi
      VpcConfig: # For accessing RDS instance
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref privateLambdaSubnet1
          - !Ref privateLambdaSubnet2
      Environment:
        Variables:
          KY_DATABASE_DEFAULT_HOST: !GetAtt IndexDatabase.Endpoint.Address
          KY_DATABASE_DEFAULT_PORT: !GetAtt IndexDatabase.Endpoint.Port
          KY_DATABASE_DEFAULT_USER: !Ref RDSMasterUserName
          KY_DATABASE_DEFAULT_AWSSECRET: !GetAtt IndexDatabase.MasterUserSecret.SecretArn
          KY_DATABASE_DEFAULT_DATABASE: !Ref RDSDBName
      Policies:
        - CloudWatchLambdaInsightsExecutionRolePolicy
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetResourcePolicy
                - secretsmanager:GetSecretValue
                - secretsmanager:DescribeSecret
                - secretsmanager:ListSecretVersionIds
              Resource: !GetAtt IndexDatabase.MasterUserSecret.SecretArn

  # ### QN Provision
  QnProvisionSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Description: QN Provision username and password
      SecretString: '{"username":"Placeholder","password":"placeholder"}'

  QnProvisionFunction:
    Type: AWS::Serverless::Function
    Properties:
      MemorySize: 128
      Runtime: go1.x
      Handler: provision
      CodeUri: ../../quicknode/provision/lambda
      Events:
        Provision:
          Type: Api
          Properties:
            Path: /provision
            Method: post
            RestApiId:
              Ref: QnApi
            Auth:
              # Do not require QuickNode's headers
              Authorizer: NONE
        Update:
          Type: Api
          Properties:
            Path: /update
            Method: put
            RestApiId:
              Ref: QnApi
            Auth:
              # Do not require QuickNode's headers
              Authorizer: NONE
        Deactivate:
          Type: Api
          Properties:
            Path: /deactivate_endpoint
            Method: delete
            RestApiId:
              Ref: QnApi
            Auth:
              # Do not require QuickNode's headers
              Authorizer: NONE
        Deprovision:
          Type: Api
          Properties:
            Path: /deprovision
            Method: delete
            RestApiId:
              Ref: QnApi
            Auth:
              # Do not require QuickNode's headers
              Authorizer: NONE
      Environment:
        Variables:
          KY_QNPROVISION_AWSSECRET: !Ref QnProvisionSecret
          KY_QNPROVISION_TABLENAME: !Ref UsersQn
      Policies:
        - CloudWatchLambdaInsightsExecutionRolePolicy
        - AmazonDynamoDBFullAccess
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetResourcePolicy
                - secretsmanager:GetSecretValue
                - secretsmanager:DescribeSecret
                - secretsmanager:ListSecretVersionIds
              Resource: !Ref QnProvisionSecret
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - apigateway:GET
              Resource: "*"

  # ### RPC route
  RpcFunction:
    Type: AWS::Serverless::Function
    Properties:
      MemorySize: 128
      Runtime: go1.x
      Handler: query
      CodeUri: ../../query/lambda
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /rpc
            Method: post
            RequestModel:
              Model: RpcRequest
              Required: true
              ValidateBody: true
            Auth:
              ApiKeyRequired: true
            RestApiId:
              Ref: QnApi
      Environment:
        Variables:
          KY_QUERY_MAXLIMIT: 1000
          KY_DATABASE_DEFAULT_HOST: !GetAtt IndexDatabase.Endpoint.Address
          KY_DATABASE_DEFAULT_PORT: !GetAtt IndexDatabase.Endpoint.Port
          KY_DATABASE_DEFAULT_USER: !Ref RDSMasterUserName
          KY_DATABASE_DEFAULT_PASSWORD: "" # Used only in integration tests
          KY_DATABASE_DEFAULT_AWSSECRET: !GetAtt IndexDatabase.MasterUserSecret.SecretArn
          KY_DATABASE_DEFAULT_DATABASE: !Ref RDSDBName
      VpcConfig: # For accessing RDS instance
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref privateLambdaSubnet1
          - !Ref privateLambdaSubnet2
      Policies:
        - CloudWatchLambdaInsightsExecutionRolePolicy
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetResourcePolicy
                - secretsmanager:GetSecretValue
                - secretsmanager:DescribeSecret
                - secretsmanager:ListSecretVersionIds
              Resource: !GetAtt IndexDatabase.MasterUserSecret.SecretArn

  ###
  # Plans
  ###

  ### QN plans

  UsagePlanQnBetaTest:
    Type: 'AWS::ApiGateway::UsagePlan'
    DependsOn:
      # - QnApi
      - QnApiStage
    Properties:
      ApiStages:
        - ApiId: !Ref QnApi
          Stage: !Ref QnApiStageName
      Description: Test plan for QN beta testing
      Quota:
        Limit: 500
        Period: MONTH
      Throttle:
            BurstLimit: 100
            RateLimit: 10
      UsagePlanName: qn-beta-test
  ApiKeyQnBetaTest:
    Type: 'AWS::ApiGateway::ApiKey'
    DependsOn:
      - UsagePlanQnBetaTest
    Properties:
      # Note: due to SAM limitations, name of the plan HAS to be the same
      # as plan slug defined in QN
      Name: !Ref QnBetaTestApiKeyName
      Enabled: true
  LinkUsagePlanApiKeyQnBetaTest:
    Type: 'AWS::ApiGateway::UsagePlanKey'
    Properties:
      KeyId: !Ref ApiKeyQnBetaTest
      KeyType: API_KEY
      UsagePlanId: !Ref UsagePlanQnBetaTest

  ###
  # S3 object storage
  ###

  # Not used:
  # IndexBucket:
  #   Type: AWS::S3::Bucket
  #   Properties:
  #     BucketName: trueblocks-qn-index

  ###
  # Network
  ###

  # create VPC
  RDSVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 172.32.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true

  # create subnets
  privateDBSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RDSVPC
      CidrBlock: 172.32.0.0/20
      AvailabilityZone: !Select [ 0, !GetAZs ]

  privateDBSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RDSVPC
      CidrBlock: 172.32.16.0/20
      AvailabilityZone: !Select [ 1, !GetAZs ]

  privateLambdaSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RDSVPC
      CidrBlock: 172.32.32.0/20
      AvailabilityZone: !Select [ 0, !GetAZs ]

  privateLambdaSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RDSVPC
      CidrBlock: 172.32.48.0/20
      AvailabilityZone: !Select [ 1, !GetAZs ]

  RDSSubnetGroup:
    Type: "AWS::RDS::DBSubnetGroup"
    Properties:
      DBSubnetGroupDescription: "description"
      SubnetIds:
        - !Ref privateDBSubnet1
        - !Ref privateDBSubnet2

  # Security groups
  # https://repost.aws/knowledge-center/connect-lambda-to-an-rds-instance

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    DependsOn:
      - LambdaSecurityGroup
    Properties:
      GroupDescription: Allow Postgres access from lambda subnets
      VpcId: !Ref RDSVPC
      # Make sure the database is only accessible from the stack, database port only
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 5432
        ToPort: 5432
        SourceSecurityGroupId : !Ref LambdaSecurityGroup
      # Make it accessible from DevOps instances, too
      - IpProtocol: tcp
        FromPort: 5432
        ToPort: 5432
        SourceSecurityGroupId : !Ref DevOpsInstanceSecurityGroup

  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    DependsOn:
      - RDSVPC
    Properties:
      GroupDescription: Security group for Lambda ENIs
      VpcId: !Ref RDSVPC
      # Allow Lambda <-> Secrets Manager:
      SecurityGroupIngress:
        - IpProtocol: -1
          ToPort: 65535
          FromPort: 0
          CidrIp: !GetAtt privateLambdaSubnet1.CidrBlock
        - IpProtocol: -1
          ToPort: 65535
          FromPort: 0
          CidrIp: !GetAtt privateLambdaSubnet2.CidrBlock

  ### VPC Endpoints
  SecretsManagerEndpoint:
    Type: AWS::EC2::VPCEndpoint
    DependsOn:
      - LambdaSecurityGroup
    Properties:
      VpcEndpointType: Interface
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.secretsmanager'
      PrivateDnsEnabled: true
      VpcId: !Ref RDSVPC
      SubnetIds:
        - !Ref privateLambdaSubnet1
        - !Ref privateLambdaSubnet2
      SecurityGroupIds:
        - !Ref LambdaSecurityGroup

  ###
  # DevOps
  ###

  # DevOps buckets
  DevOpsDbUploadBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: key-devops-db-upload

  # DevOps EC2 instance and resources it needs

  # You can download this pair's private key from AWS Parameter Store
  DevOpsInstanceKeyPair:
      Type: AWS::EC2::KeyPair
      Properties:
        KeyName: devops-instance-keypair

  # Public internet connection configuration. It should only allow SSH and PostgreSQL connections
  PublicDevOpsSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RDSVPC
      CidrBlock: 172.32.64.0/20
      AvailabilityZone: !Select [ 0, !GetAZs ]
      MapPublicIpOnLaunch: true
  InternetGateway:
    Type: AWS::EC2::InternetGateway
  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref RDSVPC
      InternetGatewayId: !Ref InternetGateway
  PublicRouteTable:
    DependsOn:
      - InternetGatewayAttachment
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref RDSVPC
  RoutePublicSubnet:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicDevOpsSubnet
  RouteIG:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
  DevOpsInstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: DevOps SSH PSQL
      GroupDescription: Allows SSH and PostgreSQL connections to DevOps instance
      VpcId: !Ref RDSVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: 0.0.0.0/0


  # DevOps EC2 instance. Remember that SAM and CF are always turning on the instances
  # their create, so if you comment the instance out, deploy (removing it) and uncomment
  # and redeploy (creating it) it will be on and you most likely want to stop it
  DevOpsInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: "ami-0e8a34246278c21e4"
      KeyName: !Ref DevOpsInstanceKeyPair
      SecurityGroupIds:
        - !GetAtt DevOpsInstanceSecurityGroup.GroupId
      SubnetId: !Ref PublicDevOpsSubnet
      UserData: !Base64
        |
          #!/bin/sh
          sudo amazon-linux-extras install postgresql15
